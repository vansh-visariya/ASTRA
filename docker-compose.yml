version: "3.8"

# ───────────────────────────────────────────────────────────────
#  Async Federated Learning  –  Docker Compose
#
#  Usage:
#    docker compose up --build              # CPU (default 3 clients)
#    docker compose up --build --scale client=5   # 5 clients
#
#  With GPU (requires nvidia-docker runtime):
#    docker compose --profile gpu up --build
# ───────────────────────────────────────────────────────────────

x-client-base: &client-base
  build:
    context: .
    dockerfile: Dockerfile.client
  depends_on:
    server:
      condition: service_healthy
  volumes:
    - dataset-cache:/app/data
  networks:
    - fl-net
  restart: on-failure

services:
  # ── Aggregation server ────────────────────────────────────────
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    ports:
      - "5000:5000"
    volumes:
      - ./runs:/app/runs
      - dataset-cache:/app/data
    networks:
      - fl-net
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/status').raise_for_status()"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    environment:
      - PYTHONUNBUFFERED=1

  # ── Training clients ──────────────────────────────────────────
  client_0:
    <<: *client-base
    environment:
      - CLIENT_ID=client_000
      - SERVER_URL=http://server:5000

  client_1:
    <<: *client-base
    environment:
      - CLIENT_ID=client_001
      - SERVER_URL=http://server:5000

  client_2:
    <<: *client-base
    environment:
      - CLIENT_ID=client_002
      - SERVER_URL=http://server:5000

  # ── GPU variants (activated with --profile gpu) ───────────────
  server-gpu:
    build:
      context: .
      dockerfile: Dockerfile.server
    profiles: ["gpu"]
    ports:
      - "5000:5000"
    volumes:
      - ./runs:/app/runs
      - dataset-cache:/app/data
    networks:
      - fl-net
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/status').raise_for_status()"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - PYTHONUNBUFFERED=1
      - CUDA_VISIBLE_DEVICES=0

volumes:
  dataset-cache:

networks:
  fl-net:
    driver: bridge
